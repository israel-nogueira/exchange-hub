name: ğŸ©º Exchange API Health Check

on:
  # â”€â”€ Agendado: todo dia Ã s 08:00 UTC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  schedule:
    - cron: '0 8 * * *'

  # â”€â”€ Manual: rode quando quiser pelo GitHub Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      open_issue_on_failure:
        description: 'Abrir Issue se houver falhas?'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write   # necessÃ¡rio para abrir Issues automaticamente

jobs:
  health-check:
    name: Check All Exchange Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup PHP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: curl, json
          coverage: none

      # â”€â”€ 3. Executa o health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run endpoint health check
        id: healthcheck
        run: |
          php scripts/check-endpoints.php 2>&1 | tee check-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true   # nÃ£o quebra o workflow aqui â€” controle manual abaixo

      # â”€â”€ 4. Extrai nomes das exchanges que falharam â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Parse failed exchanges
        id: parse
        if: steps.healthcheck.outputs.exit_code != '0'
        run: |
          # Extrai a linha FAILED_EXCHANGES= do output do script PHP
          FAILED=$(grep "^FAILED_EXCHANGES=" check-output.txt | cut -d'=' -f2-)
          echo "failed_exchanges=${FAILED}" >> $GITHUB_OUTPUT

          # Conta total de falhas no JSON gerado
          FAIL_COUNT=$(php -r "
            \$r = json_decode(file_get_contents('endpoint-report.json'), true);
            echo \$r['total_fail'] ?? 0;
          ")
          echo "fail_count=${FAIL_COUNT}" >> $GITHUB_OUTPUT

          TOTAL=$(php -r "
            \$r = json_decode(file_get_contents('endpoint-report.json'), true);
            echo \$r['total_endpoints'] ?? 0;
          ")
          echo "total_endpoints=${TOTAL}" >> $GITHUB_OUTPUT

      # â”€â”€ 5. Upload dos relatÃ³rios como artefato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload health report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: endpoint-health-report-${{ github.run_id }}
          path: |
            endpoint-report.json
            endpoint-report.md
          retention-days: 30

      # â”€â”€ 6. Abre Issue automaticamente se houver falhas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Open Issue on failure
        if: |
          steps.healthcheck.outputs.exit_code != '0' &&
          (github.event_name == 'schedule' || inputs.open_issue_on_failure == 'true')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // LÃª o relatÃ³rio JSON gerado pelo script PHP
            const report = JSON.parse(fs.readFileSync('endpoint-report.json', 'utf8'));

            // Monta lista de exchanges com falha e seus endpoints problemÃ¡ticos
            const failedExchanges = Object.values(report.exchanges).filter(ex => !ex.healthy);

            let failedDetails = '';
            for (const ex of failedExchanges) {
              failedDetails += `\n### âŒ ${ex.name} (API \`${ex.api_version}\`)\n`;
              failedDetails += `> Docs: ${ex.docs_url}\n\n`;
              failedDetails += `| Endpoint | URL | Erro | LatÃªncia |\n|---|---|---|---|\n`;

              for (const [name, ep] of Object.entries(ex.endpoints)) {
                if (!ep.ok) {
                  failedDetails += `| \`${name}\` | \`${ep.url}\` | \`${ep.error ?? 'resposta invÃ¡lida'}\` | ${ep.latency_ms}ms |\n`;
                }
              }
            }

            // Monta o corpo da Issue
            const body = `## ğŸ©º Exchange API Health Check â€” Falhas Detectadas

            > **Detectado em:** ${report.generated_at}
            > **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---

            ## Resumo

            | MÃ©trica | Valor |
            |---|---|
            | Endpoints testados | ${report.total_endpoints} |
            | Endpoints OK | ${report.total_ok} |
            | **Endpoints com falha** | **${report.total_fail}** |
            | Exchanges afetadas | ${failedExchanges.length} |

            ---

            ## Exchanges com Problemas
            ${failedDetails}

            ---

            ## O que pode ter acontecido?

            - A exchange atualizou a versÃ£o da API (endpoint movido ou descontinuado)
            - A URL base ou parÃ¢metros necessÃ¡rios mudaram
            - A exchange estÃ¡ em manutenÃ§Ã£o temporÃ¡ria
            - Rate limit foi atingido durante o teste (falso positivo â€” verifique o prÃ³ximo run)

            ## Como corrigir

            1. Acesse os docs linkados acima e verifique se o endpoint mudou
            2. Atualize o \`*Config.php\` da exchange afetada em \`src/Exchanges/{Name}/\`
            3. Atualize tambÃ©m o script \`scripts/check-endpoints.php\` se necessÃ¡rio
            4. Abra um PR com a correÃ§Ã£o

            ---

            > ğŸ“ RelatÃ³rio completo disponÃ­vel nos [artefatos da run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // Verifica se jÃ¡ existe uma Issue aberta com o mesmo tÃ­tulo (evita duplicatas)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              state: 'open',
              labels: 'api-health,automated',
            });

            const alreadyOpen = existingIssues.data.some(i =>
              i.title.includes('Exchange API Health Check')
            );

            if (alreadyOpen) {
              console.log('Issue jÃ¡ existe aberta â€” adicionando comentÃ¡rio.');
              const issue = existingIssues.data.find(i => i.title.includes('Exchange API Health Check'));
              await github.rest.issues.createComment({
                owner:    context.repo.owner,
                repo:     context.repo.repo,
                issue_number: issue.number,
                body: `### ğŸ”„ Nova falha detectada em ${report.generated_at}\n\n${failedDetails}`,
              });
            } else {
              console.log('Abrindo nova Issue.');
              await github.rest.issues.create({
                owner:  context.repo.owner,
                repo:   context.repo.repo,
                title:  `ğŸš¨ Exchange API Health Check â€” ${failedExchanges.map(e => e.name).join(', ')} com falhas (${report.generated_at})`,
                body:   body,
                labels: ['api-health', 'automated', 'bug'],
              });
            }

      # â”€â”€ 7. SumÃ¡rio no GitHub Actions UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write job summary
        if: always()
        run: |
          if [ -f endpoint-report.md ]; then
            cat endpoint-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ RelatÃ³rio nÃ£o gerado" >> $GITHUB_STEP_SUMMARY
            echo "Verifique os logs da etapa anterior." >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€ 8. Falha o job se houve erros (visÃ­vel no histÃ³rico de Actions) â”€â”€â”€â”€â”€â”€â”€
      - name: Fail if endpoints broken
        if: steps.healthcheck.outputs.exit_code != '0'
        run: |
          echo "âŒ ${{ steps.parse.outputs.fail_count }} endpoint(s) falharam."
          echo "   Exchanges afetadas: ${{ steps.parse.outputs.failed_exchanges }}"
          exit 1
