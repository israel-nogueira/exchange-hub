name: ğŸ©º Exchange API Health Check

on:
  schedule:
    - cron: '0 8 * * *'

  workflow_dispatch:
    inputs:
      open_issue_on_failure:
        description: 'Abrir Issue se houver falhas?'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Check All Exchange Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup PHP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: curl, json
          coverage: none

      # â”€â”€ 3. Cria pasta de output e roda o health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run endpoint health check
        id: healthcheck
        run: |
          mkdir -p ${{ github.workspace }}/reports

          # Passa o diretÃ³rio de output como argumento para o script
          php scripts/check-endpoints.php ${{ github.workspace }}/reports
          PHP_EXIT=$?

          echo "exit_code=${PHP_EXIT}" >> $GITHUB_OUTPUT

          # Garante que o JSON existe mesmo se o script falhou parcialmente
          if [ ! -f "${{ github.workspace }}/reports/endpoint-report.json" ]; then
            echo '{"generated_at":"unknown","total_endpoints":0,"total_ok":0,"total_fail":0,"all_healthy":false,"exchanges":{}}' \
              > ${{ github.workspace }}/reports/endpoint-report.json
            echo "## âŒ Script PHP falhou antes de gerar o relatÃ³rio" \
              > ${{ github.workspace }}/reports/endpoint-report.md
          fi

          exit ${PHP_EXIT}
        continue-on-error: true

      # â”€â”€ 4. LÃª o JSON e seta outputs para os steps seguintes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Parse report
        id: parse
        if: always()
        run: |
          REPORT="${{ github.workspace }}/reports/endpoint-report.json"

          FAIL_COUNT=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_fail'] ?? 0;")
          TOTAL=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_endpoints'] ?? 0;")
          OK_COUNT=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_ok'] ?? 0;")
          GENERATED=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['generated_at'] ?? 'unknown';")

          # Lista nomes das exchanges com falha
          FAILED_NAMES=$(php -r "
            \$r = json_decode(file_get_contents('${REPORT}'), true);
            \$failed = array_filter(\$r['exchanges'] ?? [], fn(\$e) => !\$e['healthy']);
            echo implode(', ', array_column(\$failed, 'name'));
          ")

          echo "fail_count=${FAIL_COUNT}"     >> $GITHUB_OUTPUT
          echo "total=${TOTAL}"               >> $GITHUB_OUTPUT
          echo "ok_count=${OK_COUNT}"         >> $GITHUB_OUTPUT
          echo "generated_at=${GENERATED}"    >> $GITHUB_OUTPUT
          echo "failed_names=${FAILED_NAMES}" >> $GITHUB_OUTPUT

      # â”€â”€ 5. Upload dos relatÃ³rios como artefato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload health report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: endpoint-health-report-${{ github.run_id }}
          path: ${{ github.workspace }}/reports/
          retention-days: 30

      # â”€â”€ 6. SumÃ¡rio no GitHub Actions UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write job summary
        if: always()
        run: |
          REPORT_MD="${{ github.workspace }}/reports/endpoint-report.md"
          if [ -f "${REPORT_MD}" ]; then
            cat "${REPORT_MD}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ RelatÃ³rio Markdown nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€ 7. Abre ou comenta Issue se houver falhas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Open Issue on failure
        if: |
          steps.healthcheck.outputs.exit_code != '0' &&
          (github.event_name == 'schedule' || inputs.open_issue_on_failure == 'true')
        uses: actions/github-script@v7
        env:
          REPORT_PATH: ${{ github.workspace }}/reports/endpoint-report.json
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GENERATED_AT: ${{ steps.parse.outputs.generated_at }}
          FAIL_COUNT: ${{ steps.parse.outputs.fail_count }}
          TOTAL: ${{ steps.parse.outputs.total }}
          OK_COUNT: ${{ steps.parse.outputs.ok_count }}
          FAILED_NAMES: ${{ steps.parse.outputs.failed_names }}
          RUN_NUMBER: ${{ github.run_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // â”€â”€ LÃª o relatÃ³rio (jÃ¡ garantido existir no step 3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const report = JSON.parse(fs.readFileSync(process.env.REPORT_PATH, 'utf8'));

            const failedExchanges = Object.values(report.exchanges || {}).filter(ex => !ex.healthy);

            // â”€â”€ Monta bloco de detalhes por exchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let failedDetails = '';
            for (const ex of failedExchanges) {
              failedDetails += `\n### âŒ ${ex.name} (API \`${ex.api_version}\`)\n`;
              failedDetails += `> ğŸ“– Docs: ${ex.docs_url}\n\n`;
              failedDetails += `| Endpoint | URL | Erro | LatÃªncia |\n|---|---|---|---|\n`;
              for (const [name, ep] of Object.entries(ex.endpoints || {})) {
                if (!ep.ok) {
                  const errMsg = ep.error ?? 'resposta invÃ¡lida / JSON malformado';
                  failedDetails += `| \`${name}\` | \`${ep.url}\` | \`${errMsg}\` | ${ep.latency_ms}ms |\n`;
                }
              }
              failedDetails += '\n';
            }

            if (!failedDetails) {
              failedDetails = '_Nenhum detalhe disponÃ­vel â€” verifique os logs da run._\n';
            }

            const runUrl      = process.env.RUN_URL;
            const generatedAt = process.env.GENERATED_AT;
            const failCount   = process.env.FAIL_COUNT;
            const total       = process.env.TOTAL;
            const okCount     = process.env.OK_COUNT;
            const failedNames = process.env.FAILED_NAMES;
            const runNumber   = process.env.RUN_NUMBER;

            // â”€â”€ Corpo da Issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const issueBody = [
              `## ğŸ©º Exchange API Health Check â€” Falhas Detectadas`,
              ``,
              `> **Detectado em:** ${generatedAt}`,
              `> **Run:** [#${runNumber}](${runUrl})`,
              ``,
              `---`,
              ``,
              `## Resumo`,
              ``,
              `| MÃ©trica | Valor |`,
              `|---|---|`,
              `| Endpoints testados | ${total} |`,
              `| Endpoints OK | ${okCount} |`,
              `| **Endpoints com falha** | **${failCount}** |`,
              `| Exchanges afetadas | ${failedExchanges.length} |`,
              ``,
              `---`,
              ``,
              `## Exchanges com Problemas`,
              ``,
              failedDetails,
              `---`,
              ``,
              `## O que pode ter acontecido?`,
              ``,
              `- A exchange atualizou a versÃ£o da API (endpoint movido ou descontinuado)`,
              `- A URL base ou parÃ¢metros necessÃ¡rios mudaram`,
              `- A exchange estÃ¡ em manutenÃ§Ã£o temporÃ¡ria`,
              `- Rate limit atingido durante o teste (falso positivo â€” verifique o prÃ³ximo run)`,
              ``,
              `## Como corrigir`,
              ``,
              `1. Acesse os docs linkados acima e verifique se o endpoint mudou`,
              `2. Atualize o \`*Config.php\` da exchange afetada em \`src/Exchanges/{Name}/\``,
              `3. Atualize tambÃ©m o script \`scripts/check-endpoints.php\` se necessÃ¡rio`,
              `4. Abra um PR com a correÃ§Ã£o e feche esta Issue`,
              ``,
              `---`,
              ``,
              `> ğŸ“ [RelatÃ³rio completo nos artefatos da run](${runUrl})`,
            ].join('\n');

            // â”€â”€ Verifica Issues abertas existentes (evita duplicatas) â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const existing = await github.rest.issues.listForRepo({
              owner:  context.repo.owner,
              repo:   context.repo.repo,
              state:  'open',
              labels: 'api-health',
            });

            const openIssue = existing.data.find(i =>
              i.title.includes('Exchange API Health Check')
            );

            if (openIssue) {
              core.info(`Issue #${openIssue.number} jÃ¡ existe â€” adicionando comentÃ¡rio.`);
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: openIssue.number,
                body: [
                  `### ğŸ”„ Nova falha detectada â€” ${generatedAt}`,
                  ``,
                  `> [Run #${runNumber}](${runUrl})`,
                  ``,
                  failedDetails,
                ].join('\n'),
              });
            } else {
              core.info('Abrindo nova Issue.');
              await github.rest.issues.create({
                owner:  context.repo.owner,
                repo:   context.repo.repo,
                title:  `ğŸš¨ Exchange API Health Check â€” ${failedNames} com falhas (${generatedAt})`,
                body:   issueBody,
                labels: ['api-health', 'automated', 'bug'],
              });
            }

      # â”€â”€ 8. Falha o job visivelmente se houve erros â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail job if endpoints broken
        if: steps.healthcheck.outputs.exit_code != '0'
        run: |
          echo "âŒ ${{ steps.parse.outputs.fail_count }} endpoint(s) falharam."
          echo "   Exchanges afetadas: ${{ steps.parse.outputs.failed_names }}"
          exit 1
