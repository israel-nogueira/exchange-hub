name: ğŸ©º Exchange API Health Check

on:
  schedule:
    - cron: '0 8 * * *'

  workflow_dispatch:
    inputs:
      open_issue_on_failure:
        description: 'Abrir Issue se houver falhas reais?'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Check All Exchange Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup PHP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: curl, json
          coverage: none

      # â”€â”€ 3. Roda o health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # O script PHP retorna:
      #   exit 0  â†’ tudo OK ou apenas bloqueios de datacenter conhecidos
      #   exit 1  â†’ hÃ¡ falhas REAIS (endpoints quebrados inesperadamente)
      #
      - name: Run endpoint health check
        id: healthcheck
        run: |
          mkdir -p ${{ github.workspace }}/reports

          php scripts/check-endpoints.php ${{ github.workspace }}/reports
          PHP_EXIT=$?

          echo "exit_code=${PHP_EXIT}" >> $GITHUB_OUTPUT

          # Garante que o JSON existe mesmo se o PHP travou antes de salvar
          if [ ! -f "${{ github.workspace }}/reports/endpoint-report.json" ]; then
            echo '{"generated_at":"unknown","total_endpoints":0,"total_ok":0,"total_blocked":0,"total_fail":0,"all_healthy":false,"exchanges":{}}' \
              > ${{ github.workspace }}/reports/endpoint-report.json
            printf "## âŒ Script PHP falhou antes de gerar o relatÃ³rio\n" \
              > ${{ github.workspace }}/reports/endpoint-report.md
          fi

          exit ${PHP_EXIT}
        continue-on-error: true

      # â”€â”€ 4. LÃª o JSON e expÃµe os dados para os steps seguintes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Parse report
        id: parse
        if: always()
        run: |
          REPORT="${{ github.workspace }}/reports/endpoint-report.json"

          FAIL_COUNT=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_fail'] ?? 0;")
          BLOCKED=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_blocked'] ?? 0;")
          TOTAL=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_endpoints'] ?? 0;")
          OK_COUNT=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['total_ok'] ?? 0;")
          GENERATED=$(php -r "\$r=json_decode(file_get_contents('${REPORT}'),true); echo \$r['generated_at'] ?? 'unknown';")

          FAILED_NAMES=$(php -r "
            \$r = json_decode(file_get_contents('${REPORT}'), true);
            \$failed = array_filter(\$r['exchanges'] ?? [], fn(\$e) => !\$e['healthy']);
            echo implode(', ', array_column(\$failed, 'name'));
          ")

          BLOCKED_NAMES=$(php -r "
            \$r = json_decode(file_get_contents('${REPORT}'), true);
            \$blocked = array_filter(\$r['exchanges'] ?? [], fn(\$e) => (\$e['datacenter_blocked'] ?? false) && \$e['summary']['fail'] === 0);
            echo implode(', ', array_column(\$blocked, 'name'));
          ")

          echo "fail_count=${FAIL_COUNT}"     >> $GITHUB_OUTPUT
          echo "blocked=${BLOCKED}"           >> $GITHUB_OUTPUT
          echo "total=${TOTAL}"               >> $GITHUB_OUTPUT
          echo "ok_count=${OK_COUNT}"         >> $GITHUB_OUTPUT
          echo "generated_at=${GENERATED}"    >> $GITHUB_OUTPUT
          echo "failed_names=${FAILED_NAMES}" >> $GITHUB_OUTPUT
          echo "blocked_names=${BLOCKED_NAMES}" >> $GITHUB_OUTPUT

      # â”€â”€ 5. Upload dos relatÃ³rios como artefato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload health report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: endpoint-health-report-${{ github.run_id }}
          path: ${{ github.workspace }}/reports/
          retention-days: 30

      # â”€â”€ 6. SumÃ¡rio no GitHub Actions UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Write job summary
        if: always()
        run: |
          REPORT_MD="${{ github.workspace }}/reports/endpoint-report.md"
          if [ -f "${REPORT_MD}" ]; then
            cat "${REPORT_MD}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ RelatÃ³rio Markdown nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi

          # Adiciona nota sobre bloqueios de datacenter se houver
          if [ "${{ steps.parse.outputs.blocked_names }}" != "" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "### â„¹ï¸ Nota sobre bloqueios geogrÃ¡ficos" >> $GITHUB_STEP_SUMMARY
            echo "As exchanges **${{ steps.parse.outputs.blocked_names }}** bloqueiam IPs de provedores cloud (AWS/GCP/Azure)." >> $GITHUB_STEP_SUMMARY
            echo "Isso Ã© **esperado e nÃ£o Ã© um bug** â€” teste localmente com IP residencial para validar essas integraÃ§Ãµes." >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€ 7. Abre Issue apenas para falhas REAIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # Bloqueios de datacenter (Binance 451, Bybit 403, Coinbase 403)
      # NÃƒO abrem Issue â€” sÃ£o comportamentos conhecidos e documentados.
      #
      - name: Open Issue on real failures
        if: |
          steps.healthcheck.outputs.exit_code != '0' &&
          steps.parse.outputs.fail_count != '0' &&
          (github.event_name == 'schedule' || inputs.open_issue_on_failure == 'true')
        uses: actions/github-script@v7
        env:
          REPORT_PATH:  ${{ github.workspace }}/reports/endpoint-report.json
          RUN_URL:      ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GENERATED_AT: ${{ steps.parse.outputs.generated_at }}
          FAIL_COUNT:   ${{ steps.parse.outputs.fail_count }}
          TOTAL:        ${{ steps.parse.outputs.total }}
          OK_COUNT:     ${{ steps.parse.outputs.ok_count }}
          BLOCKED:      ${{ steps.parse.outputs.blocked }}
          FAILED_NAMES: ${{ steps.parse.outputs.failed_names }}
          RUN_NUMBER:   ${{ github.run_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const report = JSON.parse(fs.readFileSync(process.env.REPORT_PATH, 'utf8'));

            // Apenas exchanges com falhas REAIS (nÃ£o bloqueios de datacenter)
            const failedExchanges = Object.values(report.exchanges || {})
              .filter(ex => !ex.healthy);

            let failedDetails = '';
            for (const ex of failedExchanges) {
              failedDetails += `\n### âŒ ${ex.name} (API \`${ex.api_version}\`)\n`;
              failedDetails += `> ğŸ“– Docs: ${ex.docs_url}\n\n`;
              failedDetails += `| Endpoint | URL | Erro | LatÃªncia |\n|---|---|---|---|\n`;
              for (const [name, ep] of Object.entries(ex.endpoints || {})) {
                if (!ep.ok && !ep.blocked) {
                  failedDetails += `| \`${name}\` | \`${ep.url}\` | \`${ep.error ?? 'resposta invÃ¡lida'}\` | ${ep.latency_ms}ms |\n`;
                }
              }
              failedDetails += '\n';
            }

            if (!failedDetails) {
              core.info('Nenhuma falha real encontrada â€” abortando criaÃ§Ã£o de Issue.');
              return;
            }

            const runUrl      = process.env.RUN_URL;
            const generatedAt = process.env.GENERATED_AT;
            const failCount   = process.env.FAIL_COUNT;
            const total       = process.env.TOTAL;
            const okCount     = process.env.OK_COUNT;
            const blocked     = process.env.BLOCKED;
            const failedNames = process.env.FAILED_NAMES;
            const runNumber   = process.env.RUN_NUMBER;

            const issueBody = [
              `## ğŸ©º Exchange API Health Check â€” Falhas Reais Detectadas`,
              ``,
              `> **Detectado em:** ${generatedAt}`,
              `> **Run:** [#${runNumber}](${runUrl})`,
              ``,
              `---`,
              ``,
              `## Resumo`,
              ``,
              `| MÃ©trica | Valor |`,
              `|---|---|`,
              `| Endpoints testados | ${total} |`,
              `| âœ… Endpoints OK | ${okCount} |`,
              `| âš ï¸ Bloqueados por datacenter (esperado) | ${blocked} |`,
              `| âŒ **Falhas reais** | **${failCount}** |`,
              `| Exchanges afetadas | ${failedExchanges.length} |`,
              ``,
              `---`,
              ``,
              `## Exchanges com Falhas Reais`,
              ``,
              failedDetails,
              `---`,
              ``,
              `## O que pode ter acontecido?`,
              ``,
              `- A exchange atualizou a versÃ£o da API (endpoint movido ou descontinuado)`,
              `- A URL base ou parÃ¢metros necessÃ¡rios mudaram`,
              `- A exchange estÃ¡ em manutenÃ§Ã£o temporÃ¡ria (falso positivo â€” aguarde o prÃ³ximo run)`,
              ``,
              `## Como corrigir`,
              ``,
              `1. Acesse os docs linkados acima e verifique se o endpoint mudou`,
              `2. Atualize o \`*Config.php\` da exchange em \`src/Exchanges/{Name}/\``,
              `3. Atualize tambÃ©m \`scripts/check-endpoints.php\` se necessÃ¡rio`,
              `4. Abra um PR com a correÃ§Ã£o e feche esta Issue`,
              ``,
              `> ğŸ“ [RelatÃ³rio completo nos artefatos da run](${runUrl})`,
            ].join('\n');

            // Evita duplicatas â€” comenta na Issue existente se jÃ¡ estiver aberta
            const existing = await github.rest.issues.listForRepo({
              owner:  context.repo.owner,
              repo:   context.repo.repo,
              state:  'open',
              labels: 'api-health',
            });

            const openIssue = existing.data.find(i =>
              i.title.includes('Exchange API Health Check')
            );

            if (openIssue) {
              core.info(`Issue #${openIssue.number} jÃ¡ aberta â€” adicionando comentÃ¡rio.`);
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: openIssue.number,
                body: [
                  `### ğŸ”„ Nova falha detectada â€” ${generatedAt}`,
                  `> [Run #${runNumber}](${runUrl})`,
                  ``,
                  failedDetails,
                ].join('\n'),
              });
            } else {
              core.info('Abrindo nova Issue.');
              await github.rest.issues.create({
                owner:  context.repo.owner,
                repo:   context.repo.repo,
                title:  `ğŸš¨ Exchange API Health Check â€” ${failedNames} com falhas (${generatedAt})`,
                body:   issueBody,
                labels: ['api-health', 'automated', 'bug'],
              });
            }

      # â”€â”€ 8. Falha o job APENAS por falhas reais â€” bloqueios nÃ£o contam â”€â”€â”€â”€â”€â”€â”€
      - name: Fail job if real failures exist
        if: |
          steps.healthcheck.outputs.exit_code != '0' &&
          steps.parse.outputs.fail_count != '0'
        run: |
          echo "âŒ ${{ steps.parse.outputs.fail_count }} endpoint(s) com falha real."
          echo "   Exchanges afetadas: ${{ steps.parse.outputs.failed_names }}"
          echo ""
          if [ "${{ steps.parse.outputs.blocked_names }}" != "" ]; then
            echo "â„¹ï¸  Bloqueios geogrÃ¡ficos conhecidos (nÃ£o sÃ£o falhas): ${{ steps.parse.outputs.blocked_names }}"
          fi
          exit 1

      # â”€â”€ 9. Sucesso explÃ­cito quando sÃ³ hÃ¡ bloqueios de datacenter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Report datacenter blocks (not failures)
        if: |
          steps.healthcheck.outputs.exit_code == '0' &&
          steps.parse.outputs.blocked_names != ''
        run: |
          echo "âœ… Nenhuma falha real detectada."
          echo "â„¹ï¸  Exchanges com bloqueio geogrÃ¡fico esperado: ${{ steps.parse.outputs.blocked_names }}"
          echo "   Esses bloqueios sÃ£o normais em ambientes de datacenter â€” nÃ£o sÃ£o bugs."
